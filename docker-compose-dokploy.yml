version: "3.8"

services:
  docuseal:
    image: buyungbahari/docuseal-x:latest
    pull_policy: always
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      gotenberg:
        condition: service_started
      pdf-extractor:
        condition: service_started
    environment:
      # Koneksi DB internal docker network
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/docuseal
      
      # Gotenberg for DOCX to PDF conversion
      GOTENBERG_URL: http://gotenberg:3000
      
      # PDF Tag Extractor for accurate field positioning
      PDF_EXTRACTOR_URL: http://pdf-extractor:8000

      # IMPORTANT: Set a persistent SECRET_KEY_BASE to avoid re-setup after deploy
      # Generate with: openssl rand -hex 64
      SECRET_KEY_BASE: ${SECRET_KEY_BASE:-your_secret_key_here_replace_with_64_hex_chars}

      # OPTIONAL: kalau Docuseal butuh base URL / force https, kamu bisa tambahkan ini
      # APP_URL: https://${HOST}
      # FORCE_SSL: "true"
    volumes:
      - docuseal_data:/data/docuseal

    # ❗JANGAN expose ports di Dokploy (Traefik yang handle routing)
    # ports:
    #   - "3000:3000"

    labels:
      - "traefik.enable=true"

      # Router: domain
      - "traefik.http.routers.docuseal.rule=Host(`${HOST}`)"

      # HTTPS entrypoint (umumnya 'websecure' di Dokploy)
      - "traefik.http.routers.docuseal.entrypoints=websecure"
      - "traefik.http.routers.docuseal.tls=true"

      # Service port internal container docuseal
      - "traefik.http.services.docuseal.loadbalancer.server.port=3000"

      # (Opsional) Redirect HTTP -> HTTPS (kalau Dokploy juga punya entrypoint 'web')
      # - "traefik.http.routers.docuseal_http.rule=Host(`${HOST}`)"
      # - "traefik.http.routers.docuseal_http.entrypoints=web"
      # - "traefik.http.routers.docuseal_http.middlewares=redirect-to-https"
      # - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

    networks:
      - dokploy-network
      - internal

  # PDF Tag Extractor: Accurate {{...}} tag position extraction using PyMuPDF
  pdf-extractor:
    image: buyungbahari/docuseal-pdf-extractor:latest
    pull_policy: always
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - internal

  postgres:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: docuseal
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d docuseal"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - internal

  # Gotenberg: DOCX/DOC to PDF conversion service
  gotenberg:
    image: gotenberg/gotenberg:8
    restart: unless-stopped
    command:
      - "gotenberg"
      - "--api-timeout=60s"
      - "--libreoffice-restart-after=10"
    networks:
      - internal

networks:
  # ✅ Network Traefik milik Dokploy (biasanya sudah ada)
  dokploy-network:
    external: true

  # Network internal antar service (tidak diexpose)
  internal:
    driver: bridge

# Named volumes for persistent data across deployments
volumes:
  docuseal_data:
    driver: local
  pg_data:
    driver: local
